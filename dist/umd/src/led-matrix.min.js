!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ledMatrix=t():e.ledMatrix=t()}(this,function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);class i{static throwIfNull(e,t){if(null==e)throw`${t} property cannot be set to null`}static throwIfNegative(e,t){if(e<0)throw`${t} property cannot be set to a negative number (${e})`}static throwIfNotBetween(e,t,r,i){if(e<r||e>i)throw`Seek expects a value between ${r} and ${i}`}static getDescriptionForProperty(e,t){return`${e}'s ${t}`}}class n{constructor(e,t,r){if(this.CLASS_NAME=n.name,this._pattern=e,this._output=t,!(t.size>=r))throw`Output size (${t.size}) can't be smaller than the character's width (${r})`;if(this._width=r,t.size%r!=0)throw`Output size (${t.size}) must be divisible by the character's width (${r})`;this._height=t.size/r}get width(){return this._width}get height(){return this._height}get pattern(){return this._pattern}get output(){return this._output}getColumn(e){i.throwIfNotBetween(e,i.getDescriptionForProperty(this.CLASS_NAME,"getColumn"),0,this._width-1);let t=[];for(let r=0;r<this._height;r++)t.push(this._output.atIndex(r*this._width+e));return t}getRow(e){i.throwIfNotBetween(e,i.getDescriptionForProperty(this.CLASS_NAME,"getRow"),0,this._height-1);let t=[];for(let r=0;r<this._width;r++)t.push(this._output.atIndex(e*this._width+r));return t}hasPattern(e){return this._pattern==e}}class s{constructor(e){this._bitPerIndex=8,this._size=e.length,this._array=new Uint8Array(Math.ceil(this._size/this._bitPerIndex)),this._pointer=0,this.pushAll(e)}get size(){return this._size}push(e){if(this._pointer==this._size)throw`Bit array max size reached (${this._size})`;const t=this._createMask(this._pointer);this._matchesMask(t,this._array[this._arrayIndex(this._pointer)])?0===e&&(this._array[this._arrayIndex(this._pointer)]^=t):1===e&&(this._array[this._arrayIndex(this._pointer)]^=t),this._pointer++}pushAll(e){e.forEach(e=>{this.push(e)})}atIndex(e){if(e>this._size)throw`Index (${e}) exceeds the size of the bit array (${this._size})`;const t=this._createMask(e);return this._matchesMask(t,this._array[this._arrayIndex(e)])?1:0}atIndexRange(e,t){if(e+t-1>this._size)throw`Index (${e}) exceeds the size of the bit array (${this._size})`;const r=[];for(let i=0;i<t;i++){const t=this._createMask(e+i);r.push(this._matchesMask(t,this._array[this._arrayIndex(e+i)])?1:0)}return r}_matchesMask(e,t){return 0!=(e&t)}_createMask(e){return 1<<this._bitPerIndex-1-this._arrayIndexOffset(e)}_arrayIndex(e){return Math.floor(e/this._bitPerIndex)}_arrayIndexOffset(e){return e%this._bitPerIndex}}class a{static scale(e,t,r){const i=1/r,n=t*r,s=e.length/t*r;let a=new Array(n*s);for(let r=0;r<s;r++)for(let s=0;s<n;s++){const h=Math.floor(s*i),o=Math.floor(r*i);a[r*n+s]=e[o*t+h]}return a}}class h{constructor(){this.handlers=[]}on(e){this.handlers.push(e)}off(e){this.handlers=this.handlers.filter(t=>t!==e)}trigger(e){this.handlers.slice(0).forEach(t=>t(e))}expose(){return this}}class o{constructor(e){this.CLASS_NAME=o.name,this.onPropertyChange=new h,this._characters=[],this._letterSpacing=e.letterSpacing,this.padding=e.padding,this._size=e.size,this.onPropertyChange.trigger()}get PropertyChange(){return this.onPropertyChange.expose()}get letterSpacing(){return this._letterSpacing}get padding(){return this._padding}get characters(){return this._characters}get input(){return this._input}get size(){return this._size}get width(){const e=this._horizontalPaddingWidth()+this._totalSpacingWidth();return this._characters.length>0?e+this._characters.map(e=>e.width).reduce((e,t)=>e+t):e}get height(){return this._characters.length>0?this._verticalPaddingWidth()+this._characters.reduce((e,t)=>t.height>e.height?t:e).height:this._verticalPaddingWidth()}set letterSpacing(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"padding");i.throwIfNull(e,t),i.throwIfNegative(e,t);const r=this._letterSpacing;this._letterSpacing=e,this._emitPropertyChangeEvent(e,r)}set padding(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"padding");e.forEach(e=>{i.throwIfNull(e,t),i.throwIfNegative(e,t)});const r=1==e.length?[e[0],e[0],e[0],e[0]]:2==e.length?[e[0],e[1],e[0],e[1]]:e;if(this._padding){let e=[...this._padding];this._padding=[r[0],r[1],r[2],r[3]],this._padding[0]==e[0]&&this._padding[1]==e[1]&&this._padding[2]==e[2]&&this._padding[3]==e[3]||this.onPropertyChange.trigger()}else this._padding=[r[0],r[1],r[2],r[3]],this.onPropertyChange.trigger()}getColumnAtIndex(e){if((e%=this.width)<this._padding[3]||e>=this.width-this._padding[1])return this._createBitOffArrayOfLength(this.height+this._verticalPaddingWidth());let t,r=this._padding[3];return this._characters.some(i=>{if((r+=i.width)>e){const n=i.getColumn(e-(r-i.width));return t=this._createBitOffArrayOfLength(this._padding[0]).concat(n).concat(this._createBitOffArrayOfLength(this._padding[2])).concat(n.length<this.height?this._createBitOffArrayOfLength(this.height-n.length):[]),!0}if((r+=this._letterSpacing)>e)return t=this._createBitOffArrayOfLength(this.height+this._verticalPaddingWidth()),!0}),t}getRowAtIndex(e){if((e%=this.height)<this._padding[0]||e>=this.height-this._padding[2])return this._createBitOffArrayOfLength(this.width);let t=[].concat.apply([],this._characters.map(t=>t.getRow(e-this._padding[0]).concat(this._createBitOffArrayOfLength(this._letterSpacing))));return t=t.slice(0,t.length-this._letterSpacing),this._createBitOffArrayOfLength(this._padding[3]).concat(t).concat(this._createBitOffArrayOfLength(this._padding[1]))}load(e,t,r=1){const i="(",h=")";this._characters=[],this._size=r;for(let r=0;r<e.length;r++){let o=e[r];if("\\"===o){if(r==e.length-1)throw"No character escaped at the end of the string input";o=e[++r]}else if(o===i&&(0===r||"\\"!==e[r-1])){do{if(o+=e[++r],r==e.length)throw`Could not find the ending delimiter "${h}" for pattern ${o}`}while(e[r]!=h);o=o.slice(1,-1)}const l=t.find(o);this._characters.push(new n(l.pattern,new s(a.scale(l.output.atIndexRange(0,l.output.size),l.width,this._size)),l.width*this._size))}this._input=e,this.onPropertyChange.trigger()}_horizontalPaddingWidth(){return this._padding[1]+this._padding[3]}_totalSpacingWidth(){return(this._characters.length-1)*this._letterSpacing}_verticalPaddingWidth(){return this._padding[0]+this._padding[2]}_createBitOffArrayOfLength(e){return Array.apply(null,Array(e)).map(()=>0)}_emitPropertyChangeEvent(e,t){e!=t&&this.onPropertyChange.trigger()}}class l{constructor(e){this.CLASS_NAME=l.name,this._initiated=!1,this.onNewSequence=new h,this._params=e,this._initiated=!0,this.updateCurrentSequence(),this._params.board.PropertyChange.on(()=>{this.updateCurrentSequence()})}get NewSequence(){return this.onNewSequence.expose()}get width(){return this._params.width}get board(){return this._params.board}get increment(){return this._params.increment}get reverse(){return this._params.reverse}get scroller(){return this._params.scroller}set width(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"width");i.throwIfNull(e,t),i.throwIfNegative(e,t),this._params.width!=e&&(this._params.width=e,this.updateCurrentSequence())}set board(e){i.throwIfNull(e,i.getDescriptionForProperty(this.CLASS_NAME,"board")),this._params.board!=e&&(this._params.board=e,this.updateCurrentSequence())}set increment(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"fps");i.throwIfNull(e,t),i.throwIfNegative(e,t),this._params.increment!=e&&(this._params.increment=e,this.updateCurrentSequence())}set reverse(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"reverse");i.throwIfNull(e,t),e!=this._params.reverse&&(this._params.reverse=e,this.updateCurrentSequence())}set scroller(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"reverse");i.throwIfNull(e,t),e!=this._params.scroller&&(this._params.scroller=e,this.updateCurrentSequence())}GetCurrentSequence(){let e=[],t=0;for(let r=0;r<=this._params.scroller.loopEndIndex(this);r++)t=this._tickPanelIndex(t),e.push(this._params.scroller.generatePanelFrameAtIndex(t,this));return e}updateCurrentSequence(){if(this._initiated){const e=this.GetCurrentSequence();this.onNewSequence.trigger(e)}}_tickPanelIndex(e){return this._params.reverse?this._decrementIndex(e):this._incrementIndex(e)}_incrementIndex(e){return e>=this._params.scroller.loopEndIndex(this)?0:e+this._params.increment}_decrementIndex(e){return 0===e?this._params.scroller.loopEndIndex(this):e-this._params.increment}}class c{constructor(){this._characters=[]}get characters(){return this._characters}get height(){return Math.max.apply(Math,this._characters.map(e=>e.height))}get length(){return this._characters.length}find(e){const t=this._characters.filter(t=>t.hasPattern(e));if(t&&t.length>0)return t[0];throw`Could not find character ${e} in the alphabet`}add(e){const t=e.map(e=>e.pattern);if(t.filter((e,t,r)=>r.indexOf(e)!=t).length>0)throw"Pattern already used by another pending character";if(this._characters.length>0){if(this._characters.map(e=>e.pattern).filter(e=>-1!=t.indexOf(e)).length>0)throw"Pattern already used by another character"}this._characters.push(...e)}edit(e){let t=!1;if(this._characters.forEach((r,i,n)=>{r.pattern!=e.pattern||t||(n[i]=e,t=!0)}),!t)throw`Could not find character ${e.pattern} in the alphabet. Aborted edit operation`}delete(e){let t=!1;if(this._characters.forEach((r,i,n)=>{r.pattern!=e.pattern||t||(n.splice(i,1),t=!0)}),!t)throw`Could not find character ${e.pattern} in the alphabet. Aborted delete operation`}}class d{loopEndIndex(e){return e.board.width-1}generatePanelFrameAtIndex(e,t){let r=[];for(let i=0;i<t.width;i++)r.push(t.board.getColumnAtIndex(e+i));let i=[];for(let e=0;e<r[0].length;e++)i.push(r.map(t=>t[e]));return i}}class p{constructor(e){this.onReady=new h,this._params=this._validateParameters(e),this._panel=new l({board:new o({letterSpacing:this._params.letterSpacing,padding:this._params.padding,size:this._params.size}),increment:this._params.increment,reverse:this._params.reverse,width:this._params.panelWidth,scroller:this._params.scroller}),this.event={newSequence:this._panel.NewSequence},this._dictionary=new c}get Ready(){return this.onReady.expose()}get size(){return this._size}set size(e){this._size=e,this._panel.board.load(this.input,this._dictionary,this.size)}get loopEndIndex(){return this._panel.scroller.loopEndIndex(this._panel)}addCharacters(e){this._dictionary.add(e)}addCharacter(e){this._dictionary.add([e])}editCharacter(e){this._dictionary.edit(e)}deleteCharacter(e){this._dictionary.delete(e)}get loadedCharacters(){return this._dictionary.characters}get usedCharacters(){return this._panel.board.characters}set letterSpacing(e){this._panel.board.letterSpacing=e}get letterSpacing(){return this._panel.board.letterSpacing}set padding(e){this._panel.board.padding=e}get padding(){return this._panel.board.padding}get width(){return this._panel.board.width}get height(){return this._panel.board.height}set input(e){this._panel.board.load(e,this._dictionary)}get input(){return this._panel.board.input}get sequence(){return this._panel.GetCurrentSequence()}set scroller(e){this._panel.scroller=e}get scroller(){return this._panel.scroller}get reverse(){return this._panel.reverse}set increment(e){this._panel.increment=e}get increment(){return this._panel.increment}set reverse(e){this._panel.reverse=e}set viewportWidth(e){this._panel.width=e}get viewportWidth(){return this._panel.width}_validateParameters(e){let t={increment:1,scroller:new d,reverse:!1,panelWidth:80,letterSpacing:2,padding:[0,4],size:1};return e?(e.letterSpacing=this._valueOrDefault(e.letterSpacing,t.letterSpacing),e.padding=this._valueOrDefault(e.padding,t.padding),e.size=this._valueOrDefault(e.size,t.size),e.increment=this._valueOrDefault(e.increment,t.increment),e.scroller=this._valueOrDefault(e.scroller,t.scroller),e.reverse=this._valueOrDefault(e.reverse,t.reverse),e.panelWidth=this._valueOrDefault(e.panelWidth,t.panelWidth),e):t}_valueOrDefault(e,t){return e||t}}class u{loopEndIndex(e){return e.board.height-1}generatePanelFrameAtIndex(e,t){let r=[];for(let i=0;i<t.board.height;i++){let n;n=t.board.getRowAtIndex(e+i),r.push(n.slice(0,t.width))}return r}}var _,g,f;!function(e){e[e.Side=0]="Side",e[e.Vertical=1]="Vertical"}(_||(_={}));class m{static build(e,t){switch(e){case _.Side:return new d;case _.Vertical:return new u}}}class w{static import(e,t){fetch(e).then(e=>e.text()).then(e=>{t(w.parse(e))}).catch(t=>{throw`Couldn't fetch file: ${e}`})}static export(){}static parse(e){const t=JSON.parse(e);if(null==t)throw"Invalid character json file";if(null==t.characters)throw"Invalid character json file: Can't find property characters";return t.characters.map(e=>{if(null==e.pattern)throw"Invalid character json file: Can't find property patterns for a character";if(null==e.output)throw"Invalid character json file: Can't find property output for a character";if(null==e.width)throw"Invalid character json file: Can't find property width for a character";return new n(e.pattern,new s(e.output.map(e=>e)),e.width)})}static stringify(e){return null==e||0==e.length?JSON.stringify(""):JSON.stringify({characters:e.map(e=>({patterns:e.pattern,output:e.output.atIndexRange(0,e.output.size),width:e.width}))})}}class y{constructor(e){}render(e){if(null==this._parameters.element){if(this._parameters.element=document.getElementById(this._parameters.elementId),null==this._parameters.element)throw"Could not find the element to render led matrix"}else 0!=this._parameters.element.clientHeight&&0!=this._parameters.element.clientWidth||(this._parameters.element=document.getElementById(this._parameters.elementId))}}class S extends y{constructor(e){super(e),this._parameters={elementId:e.elementId,element:e.element,colorBitOn:e.colorBitOn?e.colorBitOn:"#00B16A",colorBitOff:e.colorBitOff?e.colorBitOff:"#22313F",colorStrokeOn:e.colorStrokeOn?e.colorStrokeOn:"#67809F",colorStrokeOff:e.colorStrokeOff?e.colorStrokeOff:"#67809F"}}get parameters(){return this._parameters}get element(){return this._parameters.element}render(e){super.render(e);const t=this.element.getContext("2d");this.element.width!=this.element.clientWidth&&0!=this.element.clientWidth&&(this.element.width=this.element.clientWidth),this.element.height!=this.element.clientHeight&&0!=this.element.clientHeight&&(this.element.height=this.element.clientHeight),t.clearRect(0,0,this.element.width,this.element.height);const r=Math.floor(this.element.width/e[0].length),i=Math.floor(this.element.height/e.length);t.lineWidth=1;const n=(n,s,a)=>{t.strokeStyle=a,t.fillStyle=s,t.beginPath();for(var h=0;h<e.length;h++)for(var o=0;o<e[h].length;o++)e[h][o]==n&&(this.moveToNextBit(t,h,o,r,i),this.drawBit(t,h,o,r,i));t.fill(),t.stroke()};n(0,this._parameters.colorBitOff,this._parameters.colorStrokeOff),n(1,this._parameters.colorBitOn,this._parameters.colorStrokeOn)}}!function(e){e.Ellipse=class extends S{constructor(e){super(e)}moveToNextBit(e,t,r,i,n){e.moveTo(i*(r+1),n*(t+1)-n/2)}drawBit(e,t,r,i,n){const s=i/2,a=n/2;e.ellipse(i*r+s,n*t+a,s,a,0,0,2*Math.PI)}};e.Rect=class extends S{constructor(e){super(e)}drawBit(e,t,r,i,n){return e.rect(i*r,n*t,i,n)}moveToNextBit(e,t,r,i,n){}}}(g||(g={}));class x extends y{constructor(e){super(e),this._parameters={elementId:e.elementId,element:e.element,characterBitOn:e.characterBitOn?e.characterBitOn:"X",characterBitOff:e.characterBitOff?e.characterBitOff:" "}}get parameters(){return this._parameters}render(e){super.render(e);let t="";for(var r=0;r<e.length;r++){for(var i=0;i<e[r].length;i++)t+=1==e[r][i]?this._parameters.characterBitOn:this._parameters.characterBitOff;t+="\n"}this._parameters.element.innerHTML=t}}!function(e){e[e.ASCII=0]="ASCII",e[e.CanvasSquare=1]="CanvasSquare",e[e.CanvasCircle=2]="CanvasCircle"}(f||(f={}));class I{static build(e,t){switch(e){case f.ASCII:return new x({elementId:t});case f.CanvasSquare:return new g.Rect({elementId:t});case f.CanvasCircle:return new g.Ellipse({elementId:t})}}}class P{constructor(e){this.CLASS_NAME=P.name,this.onPanelUpdate=new h,this.onReachingBoundary=new h,this._index=0,this.fps=e.fps,this._renderer=e.renderer,this._sequence=e.sequence}get PanelUpdate(){return this.onPanelUpdate.expose()}get ReachingBoundary(){return this.onReachingBoundary.expose()}get sequence(){return this._sequence}get index(){return this._index}get fps(){return this._fps}get renderer(){return this._renderer}set sequence(e){i.throwIfNull(e,i.getDescriptionForProperty(this.CLASS_NAME,"sequence")),this._sequence=e}set fps(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"fps");i.throwIfNull(e,t),i.throwIfNotBetween(e,t,0,60),this._fps=e,this._fpsIntervalLengthInMs=1e3/this._fps}set renderer(e){i.throwIfNull(e,i.getDescriptionForProperty(this.CLASS_NAME,"renderer")),this._renderer=e,this._render()}play(){this._index=0,this._render(),this._startLoop()}stop(){this._index=0,this._render(),this._shouldUpdate=!1}resume(){this._startLoop()}pause(){this._shouldUpdate=!1}step(){this._nextPanelFrame()}seek(e){const t=i.getDescriptionForProperty(this.CLASS_NAME,"seek");i.throwIfNull(e,t),i.throwIfNotBetween(e,t,0,this._sequence.length),this._index=e,this._render()}setRendererFromBuilder(e){this.renderer=I.build(e.rendererType,e.elementId)}_nextPanelFrame(){i.throwIfNull(this._sequence,i.getDescriptionForProperty(this.CLASS_NAME,"sequence")),this._incrementIndex(),this._render()}_render(){this.onPanelUpdate.trigger({display:this._sequence[this._index]}),this._renderer.render(this._sequence[this._index])}_incrementIndex(){this._index>=this._sequence.length&&this.onReachingBoundary.trigger(),this._index=(this._index+1)%this._sequence.length}_startLoop(){this._then=Date.now(),this._shouldUpdate=!0,this._loop()}_loop(){requestAnimationFrame(this._loop.bind(this)),this._shouldUpdate&&this._callIfReadyForNextFrame(this._nextPanelFrame.bind(this))}_callIfReadyForNextFrame(e){this._now=Date.now(),this._elapsed=this._now-this._then,this._elapsed>this._fpsIntervalLengthInMs&&(this._then=this._now-this._elapsed%this._fpsIntervalLengthInMs,e())}}class v{constructor(e,t){this.onReady=new h,this._params=this._validateParameters(t),this._panelPlayer=new P({fps:this._params.fps,renderer:this._params.renderer,sequence:e}),this.event={panelUpdate:this._panelPlayer.PanelUpdate,reachingBoundary:this._panelPlayer.ReachingBoundary}}get Ready(){return this.onReady.expose()}index(){this._panelPlayer.index}set renderer(e){this._panelPlayer.renderer=e}get renderer(){return this._panelPlayer.renderer}set fps(e){this._panelPlayer.fps=e}get fps(){return this._panelPlayer.fps}set sequence(e){this._panelPlayer.sequence=e}get sequence(){return this._panelPlayer.sequence}play(){this._panelPlayer.play()}stop(){this._panelPlayer.stop()}pause(){this._panelPlayer.pause()}resume(){this._panelPlayer.resume()}step(){this._panelPlayer.step()}seek(e){this._panelPlayer.seek(e)}_validateParameters(e){let t={fps:30,renderer:new g.Rect({elementId:"led-matrix"})};return e?(e.fps=this._valueOrDefault(e.fps,t.fps),e.renderer=this._valueOrDefault(e.renderer,t.renderer),e):t}_valueOrDefault(e,t){return e||t}}r.d(t,"LedMatrix",function(){return p}),r.d(t,"ScrollerTypes",function(){return _}),r.d(t,"ScrollerBuilder",function(){return m}),r.d(t,"SideScroller",function(){return d}),r.d(t,"VerticalScroller",function(){return u}),r.d(t,"Board",function(){return o}),r.d(t,"CharacterDictionary",function(){return c}),r.d(t,"CharactersJSON",function(){return w}),r.d(t,"NearestNeighbor",function(){return a}),r.d(t,"Character",function(){return n}),r.d(t,"Panel",function(){return l}),r.d(t,"LedMatrixPlayer",function(){return v}),r.d(t,"AsciiRenderer",function(){return x}),r.d(t,"CanvasRenderer",function(){return S}),r.d(t,"CanvasRenderers",function(){return g}),r.d(t,"RendererTypes",function(){return f}),r.d(t,"RendererBuilder",function(){return I}),r.d(t,"Renderer",function(){return y}),r.d(t,"PanelPlayer",function(){return P}),r.d(t,"BitArray",function(){return s}),r.d(t,"Event",function(){return h}),r.d(t,"Exception",function(){return i})}])});
//# sourceMappingURL=led-matrix.min.js.map