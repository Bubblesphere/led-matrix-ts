!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ledMatrix=t():e.ledMatrix=t()}(this,function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);class i{constructor(e){this._bitPerIndex=8,this._size=e.length,this._array=new Uint8Array(Math.ceil(this._size/this._bitPerIndex)),this._pointer=0,this.pushAll(e)}get size(){return this._size}push(e){if(this._pointer==this._size)throw`Bit array max size reached (${this._size})`;const t=this._createMask(this._pointer);this._matchesMask(t,this._array[this._arrayIndex(this._pointer)])?0===e&&(this._array[this._arrayIndex(this._pointer)]^=t):1===e&&(this._array[this._arrayIndex(this._pointer)]^=t),this._pointer++}pushAll(e){e.forEach(e=>{this.push(e)})}atIndex(e){if(e>this._size)throw`Index (${e}) exceeds the size of the bit array (${this._size})`;const t=this._createMask(e);return this._matchesMask(t,this._array[this._arrayIndex(e)])?1:0}atIndexRange(e,t){if(e+t-1>this._size)throw`Index (${e}) exceeds the size of the bit array (${this._size})`;const r=[];for(let i=0;i<t;i++){const t=this._createMask(e+i);r.push(this._matchesMask(t,this._array[this._arrayIndex(e+i)])?1:0)}return r}_matchesMask(e,t){return 0!=(e&t)}_createMask(e){return 1<<this._bitPerIndex-1-this._arrayIndexOffset(e)}_arrayIndex(e){return Math.floor(e/this._bitPerIndex)}_arrayIndexOffset(e){return e%this._bitPerIndex}}class n{constructor(e){this._characters=[],this._letterSpacing=e.letterSpacing,this.padding=e.padding}set letterSpacing(e){if(null==e)throw"Board's spacing cannot be set to null";if(e<0)throw`Board's spacing cannot be set to a negative number (${e})`;this._letterSpacing=e}get letterSpacing(){return this._letterSpacing}get characters(){return this._characters}get input(){return this._input}set padding(e){e.forEach(t=>{if(null==t)throw"Board's padding cannot set to null";if(t<0)throw`Board's padding cannot be set to a negative number (${e})`}),1==e.length?this._padding=[e[0],e[0],e[0],e[0]]:2==e.length?this._padding=[e[0],e[1],e[0],e[1]]:this._padding=e}get padding(){return this._padding}get width(){const e=this._horizontalPaddingWidth()+this._totalSpacingWidth();return this._characters.length>0?e+this._characters.map(e=>e.width).reduce((e,t)=>e+t):e}get height(){return this._characters.length>0?this._verticalPaddingWidth()+this._characters.reduce((e,t)=>t.height>e.height?t:e).height:this._verticalPaddingWidth()}getColumnAtIndex(e){if((e%=this.width)<this._padding[3]||e>=this.width-this._padding[1])return this._createBitOffArrayOfLength(this.height);let t,r=this._padding[3];return this._characters.some(i=>{if((r+=i.width)>e){const n=i.getColumn(e-(r-i.width));return t=this._createBitOffArrayOfLength(this._padding[0]).concat(n).concat(this._createBitOffArrayOfLength(this._padding[2])).concat(n.length<this.height?this._createBitOffArrayOfLength(this.height-n.length):[]),!0}if((r+=this._letterSpacing)>e)return t=this._createBitOffArrayOfLength(this.height),!0}),t}getRowAtIndex(e){if((e%=this.height)<this._padding[0]||e>=this.height-this._padding[2])return this._createBitOffArrayOfLength(this.width);let t=[].concat.apply([],this._characters.map(t=>t.getRow(e-this._padding[0]).concat(this._createBitOffArrayOfLength(this._letterSpacing))));return t=t.slice(0,t.length-this._letterSpacing),this._createBitOffArrayOfLength(this._padding[3]).concat(t).concat(this._createBitOffArrayOfLength(this._padding[1]))}load(e,t){const r="(",i=")";this._characters=[];for(let n=0;n<e.length;n++){let a=e[n];if("~"===a){if(n==e.length-1)throw"No character escaped at the end of the string input";a=e[++n]}else if(a===r&&(0===n||"~"!==e[n-1])){do{if(a+=e[++n],n==e.length)throw`Could not find the ending delimiter "${i}" for pattern ${a}`}while(e[n]!=i);a=a.slice(1,-1)}this._characters.push(t.find(a))}this._input=e}_horizontalPaddingWidth(){return this._padding[1]+this._padding[3]}_totalSpacingWidth(){return(this._characters.length-1)*this._letterSpacing}_verticalPaddingWidth(){return this._padding[0]+this._padding[2]}_createBitOffArrayOfLength(e){return Array.apply(null,Array(e)).map(()=>0)}}class a{constructor(e,t,r){if(this._pattern=e,this._output=t,!(t.size>=r))throw`Output size (${t.size}) can't be smaller than the character's width (${r})`;if(this._width=r,t.size%r!=0)throw`Output size (${t.size}) must be divisible by the character's width (${r})`;this._height=t.size/r}getColumn(e){if(e<0)throw`Index (${e}) cannot be negative`;if(e>=this._width)throw`Index (${e}) is greater than the width of the character (${this._width})`;let t=[];for(let r=0;r<this._height;r++)t.push(this._output.atIndex(r*this._width+e));return t}getRow(e){if(e<0)throw`Index (${e}) cannot be negative`;if(e>=this._height)throw`Index (${e}) is greater than the height of the character (${this._height})`;let t=[];for(let r=0;r<this._width;r++)t.push(this._output.atIndex(e*this._width+r));return t}get width(){return this._width}get height(){return this._height}get pattern(){return this._pattern}get output(){return this._output}hasPattern(e){return this._pattern==e}}class s{constructor(){this._characters=[]}find(e){const t=this._characters.filter(t=>t.hasPattern(e));if(t&&t.length>0)return t[0];throw`Could not find character ${e} in the alphabet`}get characters(){return this._characters}get height(){return Math.max.apply(Math,this._characters.map(e=>e.height))}get length(){return this._characters.length}add(e){const t=e.map(e=>e.pattern);if(t.filter((e,t,r)=>r.indexOf(e)!=t).length>0)throw"Pattern already used by another pending character";if(this._characters.length>0){if(this._characters.map(e=>e.pattern).filter(e=>-1!=t.indexOf(e)).length>0)throw"Pattern already used by another character"}this._characters.push(...e)}edit(e){let t=!1;if(this._characters.forEach((r,i,n)=>{r.pattern!=e.pattern||t||(n[i]=e,t=!0)}),!t)throw`Could not find character ${e.pattern} in the alphabet. Aborted edit operation`}delete(e){let t=!1;if(this._characters.forEach((r,i,n)=>{r.pattern!=e.pattern||t||(n.splice(i,1),t=!0)}),!t)throw`Could not find character ${e.pattern} in the alphabet. Aborted delete operation`}}class h{static scale(e,t,r){const i=1/r,n=t*r,a=e.length/t*r;let s=new Array(n*a);for(let r=0;r<a;r++)for(let a=0;a<n;a++){const h=Math.floor(a*i),l=Math.floor(r*i);s[r*n+a]=e[l*t+h]}return s}}class l{static import(e,t,r){fetch(e).then(e=>e.text()).then(e=>{r(l.parse(e,t))}).catch(t=>{throw`Couldn't fetch file: ${e}`})}static export(){}static parse(e,t){if(t<1||t>10)throw"Size should be between 1 and 10";const r=JSON.parse(e);if(null==r)throw"Invalid character json file";if(null==r.characters)throw"Invalid character json file: Can't find property characters";return r.characters.map(e=>{if(null==e.pattern)throw"Invalid character json file: Can't find property patterns for a character";if(null==e.output)throw"Invalid character json file: Can't find property output for a character";if(null==e.width)throw"Invalid character json file: Can't find property width for a character";const r=e.output.map(e=>e),n=h.scale(r,e.width,t);return new a(e.pattern,new i(n),e.width*t)})}static stringify(e){return null==e||0==e.length?JSON.stringify(""):JSON.stringify({characters:e.map(e=>({patterns:e.pattern,output:e.output.atIndexRange(0,e.output.size),width:e.width}))})}}class d{constructor(){this.handlers=[]}on(e){this.handlers.push(e)}off(e){this.handlers=this.handlers.filter(t=>t!==e)}trigger(e){this.handlers.slice(0).forEach(t=>t(e))}expose(){return this}}class o{constructor(e){this.onPanelUpdate=new d,this.onReachingBoundary=new d,this.width=e.width,this.fps=e.fps,this._board=e.board,this._index=0,this._increment=e.increment,this.display=[],this._renderer=e.renderer,this._reverse=e.reverse}get PanelUpdate(){return this.onPanelUpdate.expose()}get ReachingBoundary(){return this.onReachingBoundary.expose()}get index(){return this._index}set width(e){if(null==e)throw"Panel's width cannot be set to null";if(e<0)throw`Panel's width cannot be set to a negative number (${e})`;this._width=e}get width(){return this._width}set fps(e){if(null==e)throw"Panel's fps cannot be set to null";if(e<0)throw`Panel's fps cannot be set to a negative number (${e})`;if(e>60)throw"Panel's fps has to be lower than 60";this._fps=e,this._fpsInterval=1e3/this._fps}get fps(){return this._fps}set board(e){if(null==e)throw"Panel's board cannot be set to null";this._board=e}get board(){return this._board}set increment(e){if(null==e)throw"Panel's fps cannot be set to a null value";if(e<0)throw`Panel's fps cannot be set to a negative number (${e})`;this._increment=e}get increment(){return this._increment}set renderer(e){if(null==e)throw"Panel's renderer cannot be set to null";this._renderer=e}get renderer(){return this._renderer}set reverse(e){if(null==e)throw"Panel's reverse cannot be set to null";this._reverse=e}get reverse(){return this._reverse}play(){this._index=0,this._draw(),this._startLoop()}stop(){this._index=0,this._draw(),this._shouldUpdate=!1}resume(){this._startLoop()}pause(){this._shouldUpdate=!1}seek(e){if(null==e||e<0||e>this.indexUpperBound)throw`Seek expects a value between 0 and ${this.indexUpperBound}`;this._index=e,this._draw()}tick(){this._step()}_step(){this._tickIndex(),this._draw()}_draw(){this._resetPanel(),this._generateDisplay(this._index),this.onPanelUpdate.trigger({display:this.display}),this._renderer.render(this.display)}_tickIndex(){this._reverse?this._decrementIndex():this._incrementIndex()}_resetPanel(){this.display.splice(0,this.display.length);for(let e=0;e<this._board.height;e++)this.display.push(Array.apply(null,Array(this.width)).map(Number.prototype.valueOf,0))}_incrementIndex(){this._index>=this.indexUpperBound?(this.onReachingBoundary.trigger(),this._index=0):this._index+=this._increment}_decrementIndex(){0===this._index?(this.onReachingBoundary.trigger(),this._index=this.indexUpperBound):this._index-=this._increment}_startLoop(){this._then=Date.now(),this._startTime=this._then,this._shouldUpdate=!0,this._loop()}_loop(){requestAnimationFrame(this._loop.bind(this)),this._shouldUpdate&&this._onNextFrame(this._step.bind(this))}_onNextFrame(e){this._now=Date.now(),this._elapsed=this._now-this._then,this._elapsed>this._fpsInterval&&(this._then=this._now-this._elapsed%this._fpsInterval,e())}}class c extends o{constructor(e){super(e)}get indexUpperBound(){return this.board.width-1}_generateDisplay(e){for(let t=0;t<this.width;t++){let r;r=this.board.getColumnAtIndex(e+t);for(let e=0;e<this.board.height;e++)this.display[e][t]=r[e]}}}class p extends o{constructor(e){super(e)}get indexUpperBound(){return this.board.height-1}_generateDisplay(e){for(let t=0;t<this.board.height;t++){let r;r=this.board.getRowAtIndex(e+t),this.display[t]=r.slice(0,this.width)}}}var u,_,f;!function(e){e[e.SideScrollingPanel=0]="SideScrollingPanel",e[e.VerticalScrollingPanel=1]="VerticalScrollingPanel"}(u||(u={}));class g{static build(e,t){switch(e){case u.SideScrollingPanel:return new c(t);case u.VerticalScrollingPanel:return new p(t)}}}class m{constructor(e){}render(e){if(null==this._parameters.element){if(this._parameters.element=document.getElementById(this._parameters.elementId),null==this._parameters.element)throw"Could not find the element to render led matrix"}else 0!=this._parameters.element.clientHeight&&0!=this._parameters.element.clientWidth||(this._parameters.element=document.getElementById(this._parameters.elementId))}}class w extends m{constructor(e){super(e),this._parameters={elementId:e.elementId,element:e.element,colorBitOn:e.colorBitOn?e.colorBitOn:"#00B16A",colorBitOff:e.colorBitOff?e.colorBitOff:"#22313F",colorStrokeOn:e.colorStrokeOn?e.colorStrokeOn:"#67809F",colorStrokeOff:e.colorStrokeOff?e.colorStrokeOff:"#67809F"}}get parameters(){return this._parameters}get element(){return this._parameters.element}render(e){super.render(e);const t=this.element.getContext("2d");this.element.width!=this.element.clientWidth&&0!=this.element.clientWidth&&(this.element.width=this.element.clientWidth),this.element.height!=this.element.clientHeight&&0!=this.element.clientHeight&&(this.element.height=this.element.clientHeight),t.clearRect(0,0,this.element.width,this.element.height);const r=Math.floor(this.element.width/e[0].length),i=Math.floor(this.element.height/e.length);t.lineWidth=1;const n=(n,a,s)=>{t.strokeStyle=s,t.fillStyle=a,t.beginPath();for(var h=0;h<e.length;h++)for(var l=0;l<e[h].length;l++)e[h][l]==n&&(this.moveToNextBit(t,h,l,r,i),this.drawBit(t,h,l,r,i));t.fill(),t.stroke()};n(0,this._parameters.colorBitOff,this._parameters.colorStrokeOff),n(1,this._parameters.colorBitOn,this._parameters.colorStrokeOn)}}!function(e){e.Ellipse=class extends w{constructor(e){super(e)}moveToNextBit(e,t,r,i,n){e.moveTo(i*(r+1),n*(t+1)-n/2)}drawBit(e,t,r,i,n){const a=i/2,s=n/2;e.ellipse(i*r+a,n*t+s,a,s,0,0,2*Math.PI)}};e.Rect=class extends w{constructor(e){super(e)}drawBit(e,t,r,i,n){return e.rect(i*r,n*t,i,n)}moveToNextBit(e,t,r,i,n){}}}(_||(_={}));class y extends m{constructor(e){super(e),this._parameters={elementId:e.elementId,element:e.element,characterBitOn:e.characterBitOn?e.characterBitOn:"X",characterBitOff:e.characterBitOff?e.characterBitOff:" "}}get parameters(){return this._parameters}render(e){super.render(e);let t="";for(var r=0;r<e.length;r++){for(var i=0;i<e[r].length;i++)t+=1==e[r][i]?this._parameters.characterBitOn:this._parameters.characterBitOff;t+="\n"}this._parameters.element.innerHTML=t}}!function(e){e[e.ASCII=0]="ASCII",e[e.CanvasSquare=1]="CanvasSquare",e[e.CanvasCircle=2]="CanvasCircle"}(f||(f={}));class x{static build(e,t){switch(e){case f.ASCII:return new y({elementId:t});case f.CanvasSquare:return new _.Rect({elementId:t});case f.CanvasCircle:return new _.Ellipse({elementId:t})}}}class b{static getSequence(e){let t=[];e.PanelUpdate.on(e=>{t.push(e.display)});let r=e.index;e.seek(0);for(let t=0;t<=e.indexUpperBound;t++)e.tick();return e.seek(r),t}}class v{constructor(e){this.onReady=new d,this._params=this._validateParameters(e),this._board=new n({letterSpacing:this._params.letterSpacing,padding:this._params.padding}),this._panelType=this._params.panelType,this._panel=g.build(this._params.panelType,{board:this._board,renderer:this._params.renderer,fps:this._params.fps,increment:this._params.increment,reverse:this._params.reverse,width:this._params.panelWidth}),this.event={panelUpdate:this._panel.PanelUpdate,reachingBoundary:this._panel.ReachingBoundary,ready:this.Ready}}get Ready(){return this.onReady.expose()}init(e,t){l.import(this._params.pathCharacters,e||1,e=>{this._dictionary=new s,this._dictionary.add(e),this._board.load(null!=this._board.input?this._board.input:this._params.input,this._dictionary),this.onReady.trigger(),t&&t()})}get size(){return this._size}set size(e){this._size=e,this.init(e)}get index(){return this._panel.index}get indexUpperBound(){return this._panel.indexUpperBound}getSequence(){return b.getSequence(this._panel)}addCharacter(e){this._dictionary.add([e])}editCharacter(e){this._dictionary.edit(e)}deleteCharacter(e){this._dictionary.delete(e)}get loadedCharacters(){return this._dictionary.characters}get usedCharacters(){return this._board.characters}set spacing(e){this._board.letterSpacing=e,this._panel.board=this._board}get spacing(){return this._board.letterSpacing}set padding(e){this._board.padding=e,this._panel.board=this._board}get padding(){return this._board.padding}get width(){return this._board.width}get height(){return this._board.height}set input(e){this._board.load(e,this._dictionary)}get input(){return this._board.input}play(){this._panel.play()}stop(){this._panel.stop()}pause(){this._panel.pause()}resume(){this._panel.resume()}tick(){this._panel.tick()}seek(e){this._panel.seek(e)}set panelType(e){this._panelType=e,this._panel.stop(),this._panel=g.build(this._panelType,{board:this._board,renderer:this._panel.renderer,fps:this._panel.fps,increment:this._panel.increment,reverse:this._panel.reverse,width:this._panel.width}),this._panel.play()}get panelType(){return this._panelType}set renderer(e){this._panel.renderer=e}setRendererFromBuilder(e){this._panel.renderer=x.build(e.rendererType,e.elementId)}get renderer(){return this._panel.renderer}set fps(e){this._panel.fps=e}get fps(){return this._panel.fps}set increment(e){this._panel.increment=e}get increment(){return this._panel.increment}set reverse(e){this._panel.reverse=e}get reverse(){return this._panel.reverse}set viewportWidth(e){this._panel.width=e}get viewportWidth(){return this._panel.width}_validateParameters(e){const t={input:"hello world",pathCharacters:"alphabet.json",fps:30,increment:1,panelType:u.SideScrollingPanel,rendererType:f.ASCII,elementId:"led-matrix",reverse:!1,panelWidth:80,letterSpacing:2,padding:[0,4]};return e?(e.input=this._valueOrDefault(e.input,t.input),e.pathCharacters=this._valueOrDefault(e.pathCharacters,t.pathCharacters),e.letterSpacing=this._valueOrDefault(e.letterSpacing,t.letterSpacing),e.padding=this._valueOrDefault(e.padding,t.padding),e.fps=this._valueOrDefault(e.fps,t.fps),e.increment=this._valueOrDefault(e.increment,t.increment),e.panelType=this._valueOrDefault(e.panelType,t.panelType),e.reverse=this._valueOrDefault(e.reverse,t.reverse),e.panelWidth=this._valueOrDefault(e.panelWidth,t.panelWidth),null!=e.renderer?e.renderer=e.renderer:(e.rendererType=this._valueOrDefault(e.rendererType,t.rendererType),e.elementId=this._valueOrDefault(e.elementId,t.elementId),e.renderer=x.build(e.rendererType,e.elementId)),e):t}_valueOrDefault(e,t){return e||t}}r.d(t,"BitArray",function(){return i}),r.d(t,"Board",function(){return n}),r.d(t,"Character",function(){return a}),r.d(t,"CharacterDictionary",function(){return s}),r.d(t,"CharactersJSON",function(){return l}),r.d(t,"NearestNeighbor",function(){return h}),r.d(t,"Event",function(){return d}),r.d(t,"LedMatrix",function(){return v}),r.d(t,"Panel",function(){return o}),r.d(t,"PanelType",function(){return u}),r.d(t,"PanelBuilder",function(){return g}),r.d(t,"RendererType",function(){return f}),r.d(t,"RendererBuilder",function(){return x}),r.d(t,"SideScrollingPanel",function(){return c}),r.d(t,"VerticalScrollingPanel",function(){return p}),r.d(t,"AsciiRenderer",function(){return y}),r.d(t,"CanvaRenderer",function(){return w}),r.d(t,"CanvaRenderers",function(){return _}),r.d(t,"Renderer",function(){return m})}])});
//# sourceMappingURL=led-matrix.min.js.map